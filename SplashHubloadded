-- ====================================================================
-- Executor Hub: é–¢æ•°å®šç¾©å„ªå…ˆ - UIå®‰å…¨èµ·å‹•ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
-- âš ï¸ UIãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã«å¯¾å‡¦ã™ã‚‹ãŸã‚ã€é–¢æ•°å®šç¾©ã‚’æœ€å„ªå…ˆã—ã€å®Ÿè¡Œå®‰å®šæ€§ã‚’ç¢ºä¿ã—ã¾ã—ãŸã€‚
-- ====================================================================

-- -------------------------
-- ğŸ”¹ å…±é€šå®šæ•°ã¨å¤‰æ•°å®šç¾© (æœ€ä¸Šéƒ¨)
-- -------------------------
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local KILL_HEIGHT = -1000 
local GRAB_RANGE = 15 
local BASE_WALKSPEED = 16
local BOOST_WALKSPEED = 60

-- âš ï¸ æ©Ÿèƒ½ã®ON/OFFã¯ã“ã“ã§ 'false' ã‚’ 'true' ã«å¤‰æ›´ã—ã¦ãã ã•ã„
local AntiGrabEnabled = true
local KiLLGrab = true
local SpeedBoost = true
local ToyInfEnabled = true
local TargetToyID = 1
local StopTrainEnabled = true
local AutoAim = true
local AntiSeaEnabled = true
local WalkLegArmLock = true
local SilentAim = true
local AllPartCoreEnabled = true

-- å†…éƒ¨ã‚¿ã‚¹ã‚¯å¤‰æ•°
local forcedTeleportTarget = nil 
local ToyEvent = nil
local ToyCount = 0      
local StopTrainTask = nil
local KiLLGrabTask = nil
local AutoAimTask = nil
local AntiSeaTask = nil

-- -------------------------
-- âš™ï¸ ã‚³ã‚¢æ©Ÿèƒ½ã®å®šç¾© (ã™ã¹ã¦ã®é–¢æ•°ã‚’ã“ã“ã§å®šç¾©)
-- -------------------------

-- 1. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
local function GetClosestPlayer(range)
    local closest, dist = nil, range
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local char = plr.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            if hrp then
                local magnitude = (hrp.Position - Workspace.CurrentCamera.CFrame.Position).Magnitude
                if magnitude < dist then
                    closest = plr
                    dist = magnitude
                end
            end
        end
    end
    return closest
end

-- 2. Anti Grab/KiLL Grab é–¢é€£
local function FindGrabbingPlayer(targetHRP)
    local grabber = nil
    local shortestDist = 10 
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local char = plr.Character
            local otherHRP = char and char:FindFirstChild("HumanoidRootPart")
            if otherHRP then
                local dist = (otherHRP.Position - targetHRP.Position).Magnitude
                if dist < shortestDist then
                    grabber = plr
                    shortestDist = dist
                end
            end
        end
    end
    return grabber
end

local function TeleportPlayer(plr)
    local char = plr.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if hrp then
        pcall(function() hrp.CFrame = CFrame.new(hrp.Position.X, KILL_HEIGHT, hrp.Position.Z) end)
        if Rayfield then Rayfield.Notify({Title = "Anti Grab", Content = "ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç™ºå‹•: "..plr.Name.."ã‚’æµ·ã«ãƒ†ãƒ¬ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚", Duration = 3}) end
    end
end

-- 3. å„æ©Ÿèƒ½ã®Start/Stopé–¢æ•°
local function startAntiSea()
    if AntiSeaTask then task.cancel(AntiSeaTask) end
    AntiSeaTask = task.spawn(function()
        while AntiSeaEnabled do
            local char = LocalPlayer.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            if hrp and hrp.Position.Y < 0 then
                pcall(function() hrp.CFrame = hrp.CFrame + Vector3.new(0,0.5,0) end)
            end
            task.wait(0.1)
        end
    end)
end

local function stopAntiSea()
    if AntiSeaTask then task.cancel(AntiSeaTask); AntiSeaTask = nil end
end

local function startAutoAim()
    if AutoAimTask then task.cancel(AutoAimTask) end
    AutoAimTask = task.spawn(function()
        while AutoAim do
            local camera = Workspace.CurrentCamera
            if camera then
                local target = GetClosestPlayer(30)
                if target and target.Character then
                    local targetHRP = target.Character:FindFirstChild("HumanoidRootPart")
                    if targetHRP then
                        pcall(function() camera.CFrame = CFrame.new(camera.CFrame.Position, targetHRP.Position) end)
                    end
                end
            end
            task.wait(0.01)
        end
    end)
end

local function stopAutoAim()
    if AutoAimTask then task.cancel(AutoAimTask); AutoAimTask = nil end
end

local function startKiLLGrab()
    if KiLLGrabTask then task.cancel(KiLLGrabTask) end
    KiLLGrabTask = task.spawn(function()
        while KiLLGrab do
            local char = LocalPlayer.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            if not char or not hrp then task.wait(0.1); goto continue end

            if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) then
                if not forcedTeleportTarget or not forcedTeleportTarget.Parent then
                    local target = GetClosestPlayer(GRAB_RANGE)
                    if target and target.Character then
                        forcedTeleportTarget = target.Character:FindFirstChild("HumanoidRootPart")
                        if forcedTeleportTarget then
                            pcall(function() forcedTeleportTarget.CFrame = CFrame.new(forcedTeleportTarget.Position.X, KILL_HEIGHT, forcedTeleportTarget.Position.Z) end)
                        end
                    end
                end
            else
                forcedTeleportTarget = nil
            end

            if forcedTeleportTarget and forcedTeleportTarget.Parent then
                pcall(function()
                    forcedTeleportTarget.CFrame = CFrame.new(
                        forcedTeleportTarget.Position.X, 
                        KILL_HEIGHT, 
                        forcedTeleportTarget.Position.Z
                    )
                end)
            end
            
            ::continue::
            task.wait(0.01)
        end
    end)
end

local function stopKiLLGrab()
    if KiLLGrabTask then task.cancel(KiLLGrabTask); KiLLGrabTask = nil end
    forcedTeleportTarget = nil
end

local function startStopTrain()
    if StopTrainTask then task.cancel(StopTrainTask) end
    StopTrainTask = task.spawn(function()
        while StopTrainEnabled do
            for _, part in pairs(Workspace:GetDescendants()) do
                if part:IsA("BasePart") and (part.Name:lower():match("train") or part.Name:lower():match("engine")) then
                    pcall(function() part.Anchored = true end)
                end
            end
            task.wait(0.5) 
        end
    end)
end

local function stopStopTrain()
    if StopTrainTask then task.cancel(StopTrainTask); StopTrainTask = nil end
end

local function getToyEvent()
    local Events = ReplicatedStorage:FindFirstChild("Events")
    if not ToyEvent and Events then
        ToyEvent = Events:FindFirstChild("CreateToy")
    end
    return ToyEvent
end

local function startToySpawn()
    local event = getToyEvent()
    if not event then
        if Rayfield then Rayfield.Notify({Title = "MOD", Content = "ãŠã‚‚ã¡ã‚ƒç”Ÿæˆã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", Duration = 5}) end
        return
    end
    ToyCount = 0
    toySpawnTask = task.spawn(function()
        while ToyInfEnabled do
            local cameraCFrame = Workspace.CurrentCamera.CFrame
            pcall(event.FireServer, event, TargetToyID, cameraCFrame.p, cameraCFrame.LookVector)
            ToyCount = ToyCount + 1
            task.wait(0.05) 
        end
    end)
end

local function stopToySpawn()
    if toySpawnTask then task.cancel(toySpawnTask); toySpawnTask = nil end
    ToyCount = 0
end

-- -------------------------
-- â˜… Anti Grab å¼·åŒ–ãƒ­ã‚¸ãƒƒã‚¯ (ã‚¤ãƒ™ãƒ³ãƒˆæ¥ç¶š)
-- -------------------------
local function ChappieAntiGrab(char)
    local hum = char:WaitForChildOfClass("Humanoid", 5) 
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    
    if not hrp or not hum then return end
    
    local function Escape()
        if not AntiGrabEnabled and not KiLLGrab then return end
        task.defer(function()
            pcall(function()
                hum.PlatformStand = false; hum.Sit = false
                hrp.AssemblyLinearVelocity = Vector3.zero
                hrp.AssemblyAngularVelocity = Vector3.zero
                hrp.CFrame = hrp.CFrame + Vector3.new(0,0.4,0)
            end)
        end)
    end
    
    pcall(hrp.ChildAdded.Connect, hrp.ChildAdded, function(child)
        if not AntiGrabEnabled and not KiLLGrab then return end
        if child:IsA("Weld") or child:IsA("BodyMover") or child:IsA("BodyGyro") or child:IsA("BodyPosition") or child.Name:lower():match("grab") then
            Escape(); task.defer(function() pcall(child.Destroy, child) end)
        end
    end)
    
    pcall(hum.StateChanged.Connect, hum.StateChanged, function(_, new)
        if not AntiGrabEnabled then return end
        
        if new == Enum.HumanoidStateType.Ragdoll or new == Enum.HumanoidStateType.Physics or new == Enum.HumanoidStateType.PlatformStanding then
            Escape()
            
            if new == Enum.HumanoidStateType.Physics and hrp then 
                local grabber = FindGrabbingPlayer(hrp)
                if grabber then
                    TeleportPlayer(grabber)
                end
            end
        end
    end)
    
    pcall(char.DescendantAdded.Connect, char.DescendantAdded, function(d)
        if not AntiGrabEnabled and not KiLLGrab then return end
        if d:IsA("Weld") or d:IsA("Constraint") then
            Escape(); task.defer(function() pcall(d.Destroy, d) end)
        end
    end)
end

-- -------------------------
-- ğŸ”¹ RenderStepped ãƒ«ãƒ¼ãƒ— (ä½è² è·å‡¦ç†ã®ã¿)
-- -------------------------
RunService.RenderStepped:Connect(function()
    local char = LocalPlayer.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    
    if not char or not hum or not hrp then return end

    if WalkLegArmLock then
        pcall(function() hum.WalkSpeed = 0; hum.PlatformStand = true; hum.HipHeight = 0.5 end)
    else
        if not SpeedBoost and hum.WalkSpeed ~= BASE_WALKSPEED then hum.WalkSpeed = BASE_WALKSPEED end
        hum.PlatformStand = false
    end
    
    if AllPartCoreEnabled then
        for _, part in pairs(Workspace:GetDescendants()) do
            if part:IsA("BasePart") and part.CanCollide == false and part.Name:lower() ~= "handle" then
                pcall(function() part.CanTouch = true end)
            end
        end
    end
end)

-- -------------------------
-- ğŸš€ å®Ÿè¡Œé–‹å§‹ã¨UIãƒ­ãƒ¼ãƒ‰ (ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ€å¾Œ)
-- -------------------------

-- 1. Anti Grab ã‚¤ãƒ™ãƒ³ãƒˆã®æ¥ç¶š
LocalPlayer.CharacterAdded:Connect(ChappieAntiGrab)
if LocalPlayer.Character then ChappieAntiGrab(LocalPlayer.Character) end

-- 2. Speed Boost ã‚¤ãƒ™ãƒ³ãƒˆã®æ¥ç¶š (CharacterAddedã§å¯¾å¿œæ¸ˆã¿)

-- 3. Rayfieldã®ãƒ­ãƒ¼ãƒ‰ã‚’å®‰å…¨ã«è©¦è¡Œ
local success, Rayfield = pcall(function()
    return loadstring(game:HttpGet("https://sirius.menu/rayfield"))()
end)

if not success or not Rayfield then
    warn("Rayfieldã®ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚UIã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚")
end

-- 4. å„æ©Ÿèƒ½ã®åˆæœŸèµ·å‹•
if ToyInfEnabled then startToySpawn() end
if StopTrainEnabled then startStopTrain() end
if AntiSeaEnabled then startAntiSea() end
if AutoAim then startAutoAim() end
if KiLLGrab then startKiLLGrab() end

if SpeedBoost and LocalPlayer.Character then
    local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if hum then hum.WalkSpeed = BOOST_WALKSPEED end
end

-- 5. Rayfield UIã®åˆæœŸåŒ–ã¨æ¥ç¶š
if success and Rayfield then
    local Window = Rayfield:CreateWindow({ Name = "Executor Hub", LoadingTitle = "Loading UIâ€¦", LoadingSubtitle = "UI Loaded!", ConfigurationSaving = { Enabled = false } })
    
    local PlayerTab = Window:CreateTab("Player")
    PlayerTab:CreateSection("Movement")
    PlayerTab:CreateToggle({ Name = "Speed Boost", CurrentValue = SpeedBoost, Callback = function(v) SpeedBoost = v; local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid"); if hum then hum.WalkSpeed = v and BOOST_WALKSPEED or BASE_WALKSPEED end end })
    PlayerTab:CreateToggle({ Name = "WalkLegArmLock", CurrentValue = WalkLegArmLock, Callback = function(v) WalkLegArmLock = v; local hum = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid"); if hum and not v then hum.PlatformStand = false; hum.WalkSpeed = BASE_WALKSPEED end end})
    PlayerTab:CreateSection("Aim Settings")
    PlayerTab:CreateToggle({ Name = "Auto Aim", CurrentValue = AutoAim, Callback = function(v) AutoAim = v; if v then startAutoAim() else stopAutoAim() end end })
    PlayerTab:CreateToggle({ Name = "Silent Aim", CurrentValue = SilentAim, Callback = function(v) SilentAim = v end })
    
    local AntiTab = Window:CreateTab("Anti")
    AntiTab:CreateToggle({ Name = "Anti Grab (å³è„±å‡º & ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚­ãƒ«)", CurrentValue = AntiGrabEnabled, Callback = function(v) AntiGrabEnabled = v end })
    AntiTab:CreateToggle({ Name = "Anti Sea", CurrentValue = AntiSeaEnabled, Callback = function(v) AntiSeaEnabled = v; if v then startAntiSea() else stopAntiSea() end end })

    local GrabTab = Window:CreateTab("Grab")
    GrabTab:CreateToggle({ Name = "KiLL Grab (Grab & Instant Kill)", CurrentValue = KiLLGrab, Callback = function(v) KiLLGrab = v; if v then startKiLLGrab() else stopKiLLGrab() end end })
    
    local MODTab = Window:CreateTab("MOD")
    MODTab:CreateSection("Physics & Touch")
    MODTab:CreateToggle({ Name = "ALL Part Core (å…¨Partåˆ¤å®š)", CurrentValue = AllPartCoreEnabled, Callback = function(v) AllPartCoreEnabled = v end })
    MODTab:CreateSection("Game Specific (Fling Things)")
    MODTab:CreateToggle({ Name = "Stop train (åˆ—è»Šåœæ­¢)", CurrentValue = StopTrainEnabled, Callback = function(v) StopTrainEnabled = v; if v then startStopTrain() else stopStopTrain() end end })
    MODTab:CreateToggle({ Name = "Toy Inf (è‡ªå‹•ç”Ÿæˆ)", CurrentValue = ToyInfEnabled, Callback = function(v) ToyInfEnabled = v; if v then startToySpawn() else stopToySpawn() end })
    MODTab:CreateSlider({ Name = "Target Toy ID", Range = {1, 10}, Increment = 1, Suffix = "ID", CurrentValue = TargetToyID, Callback = function(v) TargetToyID = v; if Rayfield then Rayfield.Notify({Title = "Toy Inf", Content = "Target Toy IDã‚’ "..v.." ã«è¨­å®šã—ã¾ã—ãŸã€‚", Duration = 2}) end end })
end
